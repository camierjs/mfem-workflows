name: "Sanitizers"

permissions:
  actions: write

on:
  # Run on pushes to main development branches
  push:
    branches: [main]
  # Run on all pull requests
  pull_request:
  # Allow manual triggering for debugging
  workflow_dispatch:

concurrency:
  group: ${{github.workflow}}-${{github.ref}}
  cancel-in-progress: true

jobs:
  
  # Build steps for dependencies
  build-hypre:
    uses: ./.github/workflows/sanitize-build-hypre.yml
  build-metis:
    uses: ./.github/workflows/sanitize-build-metis.yml
  build-lsan:
    uses: ./.github/workflows/sanitize-build-lsan.yml
  build-libcxx:
    uses: ./.github/workflows/sanitize-build-libcxx.yml

  # Serial sanitizers: asan, msan, ubsan
  seq-asan:
    needs: [build-libcxx]
    uses: ./.github/workflows/sanitize-all-in-one.yml
    with:
      sanitizer: asan
      key: seq-asan  
  seq-msan:
    needs: [build-libcxx]
    uses: ./.github/workflows/sanitize-all-in-one.yml
    with:
      sanitizer: msan
      key: seq-msan  
  seq-ubsan:
    needs: [build-libcxx]
    uses: ./.github/workflows/sanitize-all-in-one.yml
    with:
      sanitizer: ubsan
      key: seq-ubsan

  # Parallel sanitizers: asan, ubsan
  par-asan:
    needs: [build-libcxx, build-hypre, build-metis]
    uses: ./.github/workflows/sanitize-all-in-one.yml
    with:
      sanitizer: asan
      key: par-asan
      par: true  
  par-ubsan:
    needs: [build-libcxx, build-hypre, build-metis]
    uses: ./.github/workflows/sanitize-all-in-one.yml
    with:
      sanitizer: ubsan
      key: par-ubsan
      par: true