name: "Sanitizers"

permissions:
  actions: write

on:
  # Run on pushes to main development branches
  push:
    branches: [main]
  # Run on all pull requests
  pull_request:
  # Allow manual triggering for debugging
  workflow_dispatch:

concurrency:
  group: ${{github.workflow}}-${{github.ref}}
  cancel-in-progress: true

jobs:
  #############################################################################
  build-hypre:
    uses: .github/workflows/sanitize/hypre.yml

  build-metis:
    uses: ./.github/workflows/sanitize-metis.yml

  build-file-lsan:
    uses: ./.github/workflows/sanitize-lsan.yml

  build-llvm-libcxx:
    uses: ./.github/workflows/sanitize-libcxx.yml

  #############################################################################
  # Build MFEM Serial/Parallel
  build-seq-mfem:
    needs: [build-llvm-libcxx]
    uses: ./.github/workflows/sanitize-mfem-seq.yml
  build-par-mfem:
    needs: [build-llvm-libcxx, build-hypre, build-metis]
    uses: ./.github/workflows/sanitize-mfem-par.yml

  #############################################################################
  # Check MFEM Serial/Parallel
  test-seq-check:
    needs: [build-file-lsan, build-llvm-libcxx, build-seq-mfem]
    uses: ./.github/workflows/sanitize-test-check-seq.yml
  test-par-check:
    needs: [build-file-lsan, build-llvm-libcxx, build-par-mfem]
    uses: ./.github/workflows/sanitize-test-check-par.yml

  #############################################################################
  # Examples MFEM Serial/Parallel
  test-seq-examples:
    needs: [build-file-lsan, build-llvm-libcxx, test-seq-check]
    uses: ./.github/workflows/sanitize-test-examples-seq.yml
  test-par-examples:
    needs: [build-file-lsan, build-llvm-libcxx, test-par-check]
    uses: ./.github/workflows/sanitize-test-examples-par.yml

  #############################################################################
  # Miniapps MFEM Serial/Parallel
  test-seq-miniapps:
    needs: [build-file-lsan, build-llvm-libcxx, test-seq-check]
    uses: ./.github/workflows/sanitize-test-miniapps-seq.yml
  test-par-miniapps:
    needs: [build-file-lsan, build-llvm-libcxx, test-par-check]
    uses: ./.github/workflows/sanitize-test-miniapps-par.yml

  #############################################################################
  # Tests Unit Miniapps MFEM Serial/Parallel
  test-seq-unit-miniapps:
    needs: [build-file-lsan, build-llvm-libcxx, test-seq-check]
    uses: ./.github/workflows/sanitize-test-unit-miniapps-seq.yml
  test-par-unit-miniapps:
    needs: [build-file-lsan, build-llvm-libcxx, test-par-check]
    uses: ./.github/workflows/sanitize-test-unit-miniapps-par.yml

  #############################################################################
  # Unit tests MFEM Serial/Parallel (Compile, Split & Run)
  build-seq-unit:
    needs: [build-file-lsan, build-llvm-libcxx, test-seq-check]
    uses: ./.github/workflows/sanitize-test-unit-build-seq.yml
  test-seq-unit:
    needs: [build-file-lsan, build-llvm-libcxx, build-seq-unit]
    uses: ./.github/workflows/sanitize-test-unit-run-seq.yml

  build-par-unit:
    needs: [build-file-lsan, build-llvm-libcxx, test-par-check]
    uses: ./.github/workflows/sanitize-test-unit-build-par.yml
  test-par-unit:
    needs: [build-file-lsan, build-llvm-libcxx, build-par-unit]
    uses: ./.github/workflows/sanitize-test-unit-run-par.yml