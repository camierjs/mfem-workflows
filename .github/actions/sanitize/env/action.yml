name: 'Setup Environment'
description: 'Sets up environment variables for MFEM sanitizer workflow'
inputs:

  # if 'true', then use cache to speed up the workflow while debugging
  DEBUG:
    type: string
    default: 'false'
    required: false

  LSAN_DIR:
    description: 'LSAN suppression directory'
    required: false
    type: string
    default: 'lsan'

  LSAN_FILE:
    description: 'LSAN suppression file'
    required: false
    type: string
    default: 'lsan.supp'

  CLANG_VER:
    description: 'CLANG version to use'
    required: false
    type: number
    default: 18

  # https://github.com/llvm/llvm-project/releases
  LLVM_VER:
    description: 'LLVM version to use'
    required: false
    type: string
    default: '19.1.7'

  # https://github.com/hypre-space/hypre/releases
  HYPRE_VER:
    description: 'HYPRE version to build'
    required: false
    type: string
    default: '2.19.0'

  METIS_VER:
    description: 'METIS version to build'
    required: false
    type: string
    default: '4.0.3'

  # CMAKE_GENERATOR: Ninja
  CTEST: 
    type: string
    required: false
    default: ctest -j --test-load $(nproc) --schedule-random --stop-on-failure --output-on-failure --test-dir

  # https://clang.llvm.org/docs/AddressSanitizer.html
  ASAN_OPTIONS:
    type: string
    required: false
    default: "detect_leaks=1,
              strict_init_order=1,
              strict_string_checks=1,
              check_initialization_order=1,
              detect_stack_use_after_return=1"

  # https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html
  UBSAN_OPTIONS: 
    type: string
    required: false
    default: "halt_on_error=1, print_stacktrace=1"

  # https://clang.llvm.org/docs/MemorySanitizer.html
  MSAN_OPTIONS: 
    type: string
    required: false
    default: "poison_in_dtor=1"

runs:
  using: 'composite'
  steps:
    - name: Env (Inputs)
      run: |
        echo DEBUG=${{inputs.DEBUG}} >> $GITHUB_ENV
        echo LSAN_DIR=${{inputs.LSAN_DIR}} >> $GITHUB_ENV
        echo LLVM_VER=${{inputs.LLVM_VER}} >> $GITHUB_ENV
        echo LSAN_FILE=${{inputs.LSAN_FILE}} >> $GITHUB_ENV
        echo CLANG_VER=${{inputs.CLANG_VER}} >> $GITHUB_ENV
        echo HYPRE_VER=${{inputs.HYPRE_VER}} >> $GITHUB_ENV
        echo METIS_VER=${{inputs.METIS_VER}} >> $GITHUB_ENV
        echo CTEST=${{inputs.CTEST}} >> $GITHUB_ENV
        echo ASAN_OPTIONS=${{inputs.ASAN_OPTIONS}} >> $GITHUB_ENV
        echo UBSAN_OPTIONS=${{inputs.UBSAN_OPTIONS}} >> $GITHUB_ENV
        echo MSAN_OPTIONS=${{inputs.MSAN_OPTIONS}} >> $GITHUB_ENV
      shell: bash

    - name: Env (dir)
      run: |
        echo LLVM_DIR=${{github.workspace}}/llvm >> $GITHUB_ENV
        echo HYPRE_DIR=hypre-${{inputs.HYPRE_VER}} >> $GITHUB_ENV
        echo METIS_DIR=metis-${{inputs.METIS_VER}} >> $GITHUB_ENV
      shell: bash

    - name: Env (bis)
      run: |
        echo CC=clang-${{inputs.CLANG_VER}} >> $GITHUB_ENV
        echo CXX=clang++-${{inputs.CLANG_VER}} >> $GITHUB_ENV
        echo LLVM_INC=${{env.LLVM_DIR}}/include/c++/v1 >> $GITHUB_ENV
        echo LLVM_LIB=${{env.LLVM_DIR}}/lib >> $GITHUB_ENV
        echo HYPRE_TGZ=v${{inputs.HYPRE_VER}}.tar.gz >> $GITHUB_ENV
        echo METIS_TGZ=metis-${{inputs.METIS_VER}}.tar.gz >> $GITHUB_ENV
        echo LSAN_OPTIONS=suppressions=${{github.workspace}}/${{inputs.LSAN_DIR}}/${{inputs.LSAN_FILE}} >> $GITHUB_ENV
      shell: bash

    - name: Env (ter)
      run: |
        echo LLVM_CXXFLAGS=-stdlib=libc++ -I${{env.LLVM_INC}} -Isystem${{env.LLVM_INC}} >> $GITHUB_ENV
        echo LLVM_LDFLAGS=-L${{env.LLVM_LIB}} -lc++abi -Wl,-rpath,${{env.LLVM_LIB}} >> $GITHUB_ENV
      shell: bash
  
    - name: Echo
      run: |
        echo "[LLVM_DIR] ${{ env.LLVM_DIR }}"
        echo "[HYPRE_DIR] ${{ env.HYPRE_DIR }}"
        echo "[METIS_DIR] ${{ env.METIS_DIR }}"
        echo "[CC] ${{ env.CC }}"
        echo "[CXX] ${{ env.CXX }}"
        echo "[LLVM_INC] ${{ env.LLVM_INC }}"
        echo "[LLVM_LIB] ${{ env.LLVM_LIB }}"
        echo "[HYPRE_TGZ] ${{ env.HYPRE_TGZ }}"
        echo "[METIS_TGZ] ${{ env.METIS_TGZ }}"
        echo "[LSAN_OPTIONS] ${{ env.LSAN_OPTIONS }}"
        echo "[LLVM_CXXFLAGS] ${{env.LLVM_CXXFLAGS}}"
        echo "[LLVM_LDFLAGS] ${{env.LLVM_LDFLAGS}}"
        echo "[CTEST] ${{env.CTEST}}"
        echo "[ASAN_OPTIONS] ${{env.ASAN_OPTIONS}}"
        echo "[UBSAN_OPTIONS] ${{env.UBSAN_OPTIONS}}"
        echo "[MSAN_OPTIONS] ${{env.MSAN_OPTIONS}}"
      shell: bash
  